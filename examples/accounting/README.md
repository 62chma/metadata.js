# Тестовое приложение "Счета и реализации для Бухгалтерии предприятия"
Пример на [jsfiddle](http://jsfiddle.net/oknosoft/7khanwrr/) работает только в браузерах, на основе v8 (хром, опера, яндекс).
Это особенность _jsfiddle.net_. Поддержка браузеров ie и mozilla в `metadata.js` есть, но для отладки и промышленной эксплуатации рекомендуется chrome или chromium, который одинаково стабильно работает под Windows, Linux, iOS, Mac OS X и Android.

Копия примера доступна по адресу [oknosoft.ru/assets/examples/accounting/](http://www.oknosoft.ru/assets/examples/accounting/). Код там не окружен окошками просмотра и живого редактирования, но анализировать и отлаживать его по шагам по {F12} в браузере, пожалуй, даже удобнее, чем в *jsfiddle*

Рассмотрим по шагам, сначала демо-пример в облаке. Затем - развернём тот же пример на локальном компьютере.

## Шаг №1
Цель:
- Понять, какие файлы необходимы и достаточны для старта приложения на metadata.js
- Убедиться, что для интерфейс автосгенерированных форм:
    + Работоспособен, позволяет читать и редактировать справочники и документы
    + Не требует написания клиентского кода

Читаем код js [на странице примера](http://jsfiddle.net/oknosoft/7khanwrr/). Существенные для понимания моменты:

#### Подключение _metadata.js_
```html
<script src="//www.oknosoft.ru/assets/lib/dhtmlx.min.js"></script>
<script src="//www.oknosoft.ru/assets/lib/alasql.min.js"></script>
<script src="//www.oknosoft.ru/assets/lib/metadata.min.js"></script>
```
Вызов `dhtmlx` и `alasql` можно было завернуть вовнутрь `metadata.js` и получить подключение в одну строку, но нам хотелось подчеркнуть значимость двух китов [alasql](https://github.com/agershun/alasql) и [dhtmlx](http://dhtmlx.com/docs/products/dhtmlxSuite/), на которых опирается наша библиотека.

#### Для минималистичного приложения достаточно переопределить 2 метода
```javascript
$p.settings = function(prm, modifiers){}
```
В теле этой функции следует указать пути к данным и веб-сервису 1С.

```javascript
$p.iface.oninit = function(){}
```
Эта функция схожа с событием глобального контекста 1С _При начале работы системы_. В ней следует определить состав и внешний вид объектов интерфейса пользователя.
В данном примере используется стандартный диалог авторизации и интерфейс по умолчанию, подобный команде _Все функции_ режима управляемого приложения 1С. Для настройки такого поведения главного окна, оказалось достаточно 10 строк клиентского кода javascript.

#### Метаданные
Дерево метаданных приложения строится на основании файлов описания [meta.json](data/meta.json) и [meta_patch.json](data/meta_patch.json). Файлы совершенно одинаковы по структуре и в общем случае, любой из них можно выкинуть либо не заполнять. При старте приложения, система делает попытку прочитать оба файла и суммирует полученные данные во внутреннем объекте [Meta](http://www.oknosoft.ru/upzp/apidocs/files/src_meta_meta.js.html#399).

Подход, при котором описание метаданных разделено на два файла, позволяет упростить разработку и сопровождение, т.к. файл `meta.json` формируется автоматически обработкой [ИнтеграцияОписаниеМетаданных.epf](data/ИнтеграцияОписаниеМетаданных.epf), а файл `meta_patch.json` предназначен для редактирования разработчиком. Второй файл потребовался, чтобы дополнить метаданные свойствами, которые нельзя задать или переопределить в конфигураторе 1С. Например, ширины и видимость колонок табличной части объекта или признак кеширования.

Код функции `$p.settings` должен сообщить движку metadata.js, где лежат файлы описания метаданных. За это в примере на _jsfiddle_ отвечает строка:
```javascript
prm.data_url = "//www.oknosoft.ru/assets/examples/accounting/data/";
```
При разворачивании приложения на собственном сервере, путь к данным логично указать относительно корня сайта. Например, так:
```javascript
prm.data_url = "data/";
```

Следующим, важным служебным файлом, является [create_tables.sql](data/create_tables.sql). Он формируется автоматически после первой авторизации и входа в программу командой `$p.md.create_tables()` в консоли браузера. Файл содержит инструкции `SQL` для создания в памяти браузера таблиц для размещения объектов данных. За установку параметра с адресом `SQL` отвечает строка:
```javascript
prm.create_tables = "data/create_tables.sql";
```

#### Данные
В зависимости от решаемых задач, часть данных (значения перечислений, справочники, регистры сведений и некоторые документы), могут загружаться при старте программы в память браузера. В процессе работы, доступ к таким данным не будет требовать обращения к серверу. Памятуя про [html5 AppCache](https://developer.mozilla.org/en-US/docs/Web/HTML/Using_the_application_cache), эти данные, будучи один раз прочитаны с сервера, при очередных запусках приложения, не создают сетевого трафика. Объекты данных адаптированы для автономной offline работы. На базе `metadata.js`, можно создавать рабочие места, не требующие постоянного подключения к интернет и обращающиеся к серверу только для асинхронного обмена.

Offline и прочие репликации в нашем примере не используются, а snapshot перечислений и справочников из папки [data/zones](data/zones), позволяет сильно разгрузить сервер 1С как при старте клиентских приложений, так и при оперативной работе пользователей. Папка `zones` внутри каталога `data` предназначена для хранения разных снапшотов для разделенной (фреш) публикации 1С. Для неразделенной базы, в настройках необходимо задать:
```javascript
prm.zone = 0;
```
